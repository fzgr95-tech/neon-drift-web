<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>NEON DRIFT FINAL v20.0</title>
    <style>
        body {
            background-color: #050510;
            margin: 0;
            overflow: hidden;
            font-family: 'Verdana', sans-serif;
        }

        canvas {
            display: block;
            margin: 0 auto;
            background: #050510;
            touch-action: none;
        }

        #loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffff;
            font-family: monospace;
            font-size: 20px;
            pointer-events: none;
            transition: opacity 0.5s;
            text-align: center;
        }

        #quiz-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .quiz-box {
            text-align: center;
            color: white;
            scale: 1.2;
        }

        .quiz-question {
            font-size: 30px;
            margin: 20px;
            color: yellow;
            text-shadow: 0 0 10px red;
            font-weight: bold;
        }

        .quiz-btn {
            display: inline-block;
            padding: 10px;
            margin: 15px;
            border: 2px solid cyan;
            font-size: 60px;
            cursor: pointer;
            border-radius: 20px;
            background: rgba(0, 255, 255, 0.1);
            min-width: 100px;
        }

        .quiz-btn:active {
            background: cyan;
            transform: scale(0.9);
        }

        /* HUD Font */
        @font-face {
            font-family: 'Neon';
            src: local('Consolas');
        }
    </style>
</head>

<body>

    <div id="loader">
        SYSTEM UPDATE v20.0<br>
        INSTALLING PAUSE MODULE...<br>
        SYSTEM READY...
    </div>

    <div id="quiz-overlay">
        <div class="quiz-box">
            <h2 style="color: #ff00ff;">SESLƒ∞ KOMUT Sƒ∞STEMƒ∞</h2>
            <div id="quiz-question" class="quiz-question">HANGƒ∞Sƒ∞ ELMA?</div>
            <div id="quiz-answers"></div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // === NEON DRIFT: FINAL v20.0 ===
        // Added PAUSE Functionality
        // Cleaned up HUD for Pause Button

        window.onerror = function (msg, url, line) { alert("Hata: " + msg + "\nSatƒ±r: " + line); return false; };
        var storage = { get: function (k) { try { return localStorage.getItem(k); } catch (e) { return null; } }, set: function (k, v) { try { localStorage.setItem(k, v); } catch (e) { } } };

        var LANG = {
            TR: { tap: "BA≈ûLAMAK ƒ∞√áƒ∞N DOKUN", garage: "GARAJ", settings: "AYARLAR", back: "GERƒ∞", buy: "SATIN AL", equip: "SE√á", equipped: "SE√áƒ∞LDƒ∞", speed: "HIZ", gameover: "OYUN Bƒ∞TTƒ∞", score: "SKOR", coin: "ALTIN", restart: "TEKRAR OYNA", vol: "SES", diff: "ZORLUK", graph: "GRAFƒ∞K", q_prefix: "Hangisi:", speak_prefix: "A≈üaƒüƒ±dakilerden hangisi", color: "RENK", price: "Fiyat", ammo: "MERMƒ∞", kspeed: "√áOCUK HIZI", paused: "DURAKLATILDI", resume: "DEVAM ET", menu: "ANA MEN√ú" },
            EN: { tap: "TAP TO START", garage: "GARAGE", settings: "SETTINGS", back: "BACK", buy: "BUY", equip: "EQUIP", equipped: "EQUIPPED", speed: "SPEED", gameover: "GAME OVER", score: "SCORE", coin: "GOLD", restart: "TAP TO RESTART", vol: "VOLUME", diff: "DIFFICULTY", graph: "GRAPHICS", q_prefix: "Which is:", speak_prefix: "Which one is", color: "COLOR", price: "Price", ammo: "AMMO", kspeed: "KIDS SPEED", paused: "PAUSED", resume: "RESUME", menu: "MAIN MENU" }
        };

        var EMOJIS = [
            { e: "üê∂", tr: "K√∂pek", en: "Dog" }, { e: "üê±", tr: "Kedi", en: "Cat" }, { e: "üê≠", tr: "Fare", en: "Mouse" }, { e: "üê∞", tr: "Tav≈üan", en: "Rabbit" },
            { e: "ü¶ä", tr: "Tilki", en: "Fox" }, { e: "üêª", tr: "Ayƒ±", en: "Bear" }, { e: "üêº", tr: "Panda", en: "Panda" }, { e: "ü¶Å", tr: "Aslan", en: "Lion" },
            { e: "üêØ", tr: "Kaplan", en: "Tiger" }, { e: "üêÆ", tr: "ƒ∞nek", en: "Cow" }, { e: "üê∑", tr: "Domuz", en: "Pig" }, { e: "üê∏", tr: "Kurbaƒüa", en: "Frog" },
            { e: "üêµ", tr: "Maymun", en: "Monkey" }, { e: "üêî", tr: "Tavuk", en: "Chicken" }, { e: "üêß", tr: "Penguen", en: "Penguin" }, { e: "üê¶", tr: "Ku≈ü", en: "Bird" },
            { e: "ü¶Ü", tr: "√ñrdek", en: "Duck" }, { e: "ü¶Ö", tr: "Kartal", en: "Eagle" }, { e: "ü¶â", tr: "Bayku≈ü", en: "Owl" }, { e: "üêù", tr: "Arƒ±", en: "Bee" },
            { e: "ü¶ã", tr: "Kelebek", en: "Butterfly" }, { e: "üêû", tr: "Uƒüur B√∂ceƒüi", en: "Ladybug" }, { e: "üê¢", tr: "Kaplumbaƒüa", en: "Turtle" },
            { e: "üêç", tr: "Yƒ±lan", en: "Snake" }, { e: "üêô", tr: "Ahtapot", en: "Octopus" }, { e: "üê†", tr: "Balƒ±k", en: "Fish" }, { e: "üê¨", tr: "Yunus", en: "Dolphin" },
            { e: "üçè", tr: "Ye≈üil Elma", en: "Green Apple" }, { e: "üçé", tr: "Kƒ±rmƒ±zƒ± Elma", en: "Red Apple" }, { e: "üçê", tr: "Armut", en: "Pear" }, { e: "üçä", tr: "Portakal", en: "Orange" },
            { e: "üçã", tr: "Limon", en: "Lemon" }, { e: "üçå", tr: "Muz", en: "Banana" }, { e: "üçâ", tr: "Karpuz", en: "Watermelon" }, { e: "üçá", tr: "√úz√ºm", en: "Grapes" },
            { e: "üçì", tr: "√áilek", en: "Strawberry" }, { e: "üçí", tr: "Kiraz", en: "Cherry" }, { e: "üçç", tr: "Ananas", en: "Pineapple" }, { e: "ü••", tr: "Hindistan Cevizi", en: "Coconut" },
            { e: "‚öΩ", tr: "Futbol", en: "Football" }, { e: "üèÄ", tr: "Basketbol", en: "Basketball" }, { e: "üéæ", tr: "Tenis", en: "Tennis" }, { e: "üèê", tr: "Voleybol", en: "Volleyball" },
            { e: "üé±", tr: "Bilardo", en: "Billiards" }, { e: "üöó", tr: "Araba", en: "Car" }, { e: "üöï", tr: "Taksi", en: "Taxi" }, { e: "üöì", tr: "Polis", en: "Police" },
            { e: "üöë", tr: "Ambulans", en: "Ambulance" }, { e: "üöí", tr: "ƒ∞tfaiye", en: "Fire Truck" }, { e: "üöÄ", tr: "Roket", en: "Rocket" }, { e: "‚úàÔ∏è", tr: "U√ßak", en: "Airplane" }
        ];

        var C = { CYAN: '#00ffff', PINK: '#ff00ff', YELLOW: '#ffff00', RED: '#ff3366', GREEN: '#00ff64', BLUE: '#0096ff', PURPLE: '#b400ff', WHITE: '#ffffff', DARK: '#1e1e28', ORANGE: '#ffaa00' };
        var OBSTACLE_COLORS = [C.PURPLE, C.RED, '#ff0055']; // Python colors
        var COLOR_PRICES = { CYAN: 0, PINK: 200, YELLOW: 200, RED: 200, GREEN: 200, BLUE: 200, PURPLE: 500, WHITE: 1000, ORANGE: 300 };
        var COLOR_KEYS = Object.keys(C).filter(k => k !== 'DARK');

        var VEHICLES = {
            sport: { price: 0, name: "Neon GT", speed: 1.0, defCol: 'CYAN' },
            suv: { price: 500, name: "Tank 3000", speed: 0.8, defCol: 'GREEN' },
            moto: { price: 800, name: "Tron Bike", speed: 1.3, defCol: 'YELLOW' },
            future: { price: 1500, name: "UFO-X", speed: 1.5, defCol: 'PURPLE' },
            retro: { price: 1200, name: "Delorean", speed: 1.1, defCol: 'RED' }
        };

        var cvs, ctx, w, h;
        var state = 'menu';
        var saved = {
            coins: 0, cars: ['sport'], cur: 'sport', high: 0, lang: 'TR', vol: 5, diff: 1, kSpeed: 5, lowQ: false,
            ownColors: { 'sport': ['CYAN'], 'suv': ['GREEN'], 'moto': ['YELLOW'], 'future': ['PURPLE'], 'retro': ['RED'] },
            selColor: { 'sport': 'CYAN', 'suv': 'GREEN', 'moto': 'YELLOW', 'future': 'PURPLE', 'retro': 'RED' }
        };
        var score = 0, baseSpeed = 0, speed = 0, roadOffset = 0, particles = [], bullets = [];
        var buildings = [];
        var reviveUsed = false;
        var activePowerups = { shield: 0, slow: 0, x2: 0, mag: 0 };
        var ammo = 0;

        try { var raw = storage.get('neonDataV20'); if (raw) saved = JSON.parse(raw); } catch (e) { }
        // Fallbacks for new keys
        if (!saved.ownColors) saved.ownColors = { 'sport': ['CYAN'], 'suv': ['GREEN'], 'moto': ['YELLOW'], 'future': ['PURPLE'], 'retro': ['RED'] };
        if (!saved.selColor) saved.selColor = { 'sport': 'CYAN', 'suv': 'GREEN', 'moto': 'YELLOW', 'future': 'PURPLE', 'retro': 'RED' };
        if (typeof saved.kSpeed === 'undefined') saved.kSpeed = 5;

        var T = LANG[saved.lang];

        // SES
        var audioCtx = null;
        function initAudio() { try { window.AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext(); } catch (e) { } }
        function playSound(t) {
            if (!audioCtx || saved.vol === 0) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            var o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            var v = saved.vol / 10;
            if (t === 'coin') { o.freq(1000, 2000, 0.1); g.env(0.3 * v, 0.1); o.play(0.1); }
            else if (t === 'crash') { o.type = 'sawtooth'; o.freq(100, 20, 0.3); g.env(0.5 * v, 0.3); o.play(0.3); }
            else if (t === 'shoot') { o.type = 'square'; o.freq(800, 400, 0.1); g.env(0.2 * v, 0.1); o.play(0.1); }
            else if (t === 'select') { o.type = 'triangle'; o.freq(600, 600, 0.05); g.env(0.1 * v, 0.05); o.play(0.05); }
            else if (t === 'powerup') { o.freq(400, 800, 0.2); g.env(0.3 * v, 0.2); o.play(0.2); }
            else if (t === 'error') { o.type = 'sawtooth'; o.freq(200, 100, 0.2); g.env(0.5 * v, 0.2); o.play(0.2); }
            else if (t === 'slow') { o.freq(800, 200, 1.0); g.env(0.3 * v, 1.0); o.play(1.0); }
        }
        OscillatorNode.prototype.freq = function (s, e, t) { this.frequency.setValueAtTime(s, audioCtx.currentTime); this.frequency.exponentialRampToValueAtTime(e, audioCtx.currentTime + t); };
        OscillatorNode.prototype.play = function (t) { this.start(audioCtx.currentTime); this.stop(audioCtx.currentTime + t); };
        GainNode.prototype.env = function (v, t) { this.gain.setValueAtTime(v, audioCtx.currentTime); this.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + t); };
        function speak(text) {
            if (!window.speechSynthesis || saved.vol === 0) return;
            window.speechSynthesis.cancel();
            var u = new SpeechSynthesisUtterance(text); u.lang = saved.lang === 'TR' ? 'tr-TR' : 'en-US';
            u.rate = 0.9; u.volume = saved.vol / 10; window.speechSynthesis.speak(u);
        }

        window.onload = function () {
            var V = 'v20.0';
            if (storage.get('ver') !== V) {
                storage.set('ver', V);
                if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(function (r) { r.forEach(function (i) { i.unregister() }) });
                if (window.caches) caches.keys().then(function (n) { n.forEach(function (i) { caches.delete(i) }) });
                alert("Sƒ∞STEM G√úNCELLENƒ∞YOR (v20.0)\nDurdurma √ñzelliƒüi Ekleniyor...");
                setTimeout(function () { window.location.reload(true); }, 500); return;
            }
            cvs = document.getElementById('gameCanvas'); ctx = cvs.getContext('2d');

            // Create Buildings with Windows (Python Style)
            buildings = [];
            for (var i = 0; i < 40; i++) {
                var b = { x: Math.random() * 1000, w: 40 + Math.random() * 60, h: 100 + Math.random() * 300, y: Math.random() * 1000, color: Math.random() };
                // Windows
                b.wins = [];
                for (var wy = 10; wy < b.h - 20; wy += 20) {
                    for (var wx = 5; wx < b.w - 10; wx += 15) {
                        if (Math.random() > 0.3) b.wins.push({ x: wx, y: wy, on: Math.random() > 0.5 });
                    }
                }
                buildings.push(b);
            }

            window.addEventListener('resize', resize); resize(); initInputs();
            document.getElementById('loader').style.opacity = 0; loop();
        };

        function resize() { w = window.innerWidth; h = window.innerHeight; cvs.width = w; cvs.height = h; }

        var player = { lane: 1, x: 0, y: 0, tLane: 1, m: false, p: 0 };
        var obs = [], gold = [], pow = [];
        var timers = { o: 0, g: 0, p: 0 };

        function getX(l) { var rw = Math.min(w, 600) * 0.8, le = (w - rw) / 2, lw = rw / 3; return le + lw * l + lw / 2; }

        function initInputs() {
            var tsX = 0, tsY = 0;
            cvs.addEventListener('touchstart', function (e) { e.preventDefault(); tsX = e.touches[0].clientX; tsY = e.touches[0].clientY; handleTap(tsX, tsY); }, { passive: false });
            cvs.addEventListener('touchend', function (e) {
                e.preventDefault(); var dx = e.changedTouches[0].clientX - tsX; var dy = e.changedTouches[0].clientY - tsY;
                if (state === 'playing') { if (dy < -50) shoot(); else if (Math.abs(dx) > 30) move(dx > 0 ? 1 : -1); }
            }, { passive: false });
            cvs.addEventListener('mousedown', function (e) { handleTap(e.clientX, e.clientY); });
            document.addEventListener('keydown', function (e) {
                if (state === 'playing') {
                    if (e.key === 'ArrowLeft') move(-1);
                    if (e.key === 'ArrowRight') move(1);
                    if (e.key === 'ArrowUp' || e.key === ' ') shoot();
                    if (e.key === 'p' || e.key === 'P' || e.key === 'Escape') { state = 'paused'; playSound('select'); }
                } else if (state === 'paused') {
                    if (e.key === 'p' || e.key === 'P' || e.key === 'Escape') { state = 'playing'; playSound('select'); }
                }
                if ((state === 'menu' || state === 'gameover') && e.key === 'Enter') start();
            });
        }

        function handleTap(x, y) {
            if (!audioCtx) initAudio();
            if (state === 'menu') {
                if (y < 150 && x < 150) { playSound('select'); state = 'settings'; return; }
                if (y < 150 && x > w - 150) { playSound('select'); state = 'garage'; return; }
                if (y > h / 3) start();
            } else if (state === 'settings') {
                if (y < 150 && x < 150) { playSound('select'); state = 'menu'; save(); return; }
                if (y > 200 && y < 250) { saved.vol = Math.floor(Math.max(0, Math.min(10, (x - 50) / ((w - 100) / 10)))); playSound('select'); }
                if (y > 300 && y < 350) { saved.diff = (saved.diff + 1) % 3; playSound('select'); }
                if (y > 400 && y < 450) { saved.lang = saved.lang === 'TR' ? 'EN' : 'TR'; T = LANG[saved.lang]; playSound('select'); }
                if (y > 500 && y < 550) { saved.lowQ = !saved.lowQ; playSound('select'); }
                if (saved.diff === 0 && y > 600 && y < 650) {
                    saved.kSpeed = Math.floor(Math.max(1, Math.min(10, (x - 50) / ((w - 100) / 10))));
                    playSound('select');
                }
            } else if (state === 'garage') {
                if (y < 150 && x < 150) { playSound('select'); state = 'menu'; return; }
                if (y > h - 100) buy();
                else if (x < 50 && y > h / 2 - 100 && y < h / 2 + 100) { playSound('select'); garageNav(-1); }
                else if (x > w - 50 && y > h / 2 - 100 && y < h / 2 + 100) { playSound('select'); garageNav(1); }
                else if (y > h / 2 + 80 && y < h / 2 + 140) {
                    var startX = w / 2 - (COLOR_KEYS.length * 35) / 2;
                    for (var i = 0; i < COLOR_KEYS.length; i++) { if (x > startX + i * 35 && x < startX + i * 35 + 30) { buyColor(COLOR_KEYS[i]); break; } }
                }
            } else if (state === 'playing') {
                // Check Pause Button
                if (x > w - 60 && y < 60) { state = 'paused'; playSound('select'); return; }
            } else if (state === 'paused') {
                // Resume
                if (y > h / 2 - 60 && y < h / 2 - 10) { state = 'playing'; playSound('select'); return; }
                // Menu
                if (y > h / 2 + 10 && y < h / 2 + 60) { state = 'menu'; playSound('select'); return; }
            } else if (state === 'gameover') { state = 'menu'; }
        }

        function move(d) { var n = player.lane + d; if (n >= 0 && n <= 2 && !player.m) { player.tLane = n; player.m = true; player.p = 0; } }
        function shoot() { if (ammo > 0) { bullets.push({ x: player.x, y: player.y - 30 }); ammo--; playSound('shoot'); } else playSound('error'); }

        function start() {
            playSound('select'); state = 'playing'; score = 0; obs = []; gold = []; pow = []; particles = []; bullets = [];
            var car = VEHICLES[saved.cur];
            player.lane = 1; player.tLane = 1; player.x = getX(1); player.m = false; player.y = h - 150;

            if (saved.diff === 0) {
                baseSpeed = 2 + (saved.kSpeed * 0.5);
            } else {
                baseSpeed = 6 * car.speed + saved.diff;
            }
            speed = baseSpeed;

            reviveUsed = false; activePowerups = { shield: 0, slow: 0, x2: 0, mag: 0 }; ammo = 0;
        }

        function startQuiz() {
            state = 'quiz';
            var correct = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
            var wrong = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
            while (wrong.e === correct.e) wrong = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
            var langKey = saved.lang === 'TR' ? 'tr' : 'en';
            document.getElementById('quiz-question').innerText = T.q_prefix + "\n" + correct[langKey].toUpperCase();
            var d = document.getElementById('quiz-answers'); d.innerHTML = "";
            var btn1 = `<div class="quiz-btn" onclick="quizAns('${correct.e}', '${correct.e}')">${correct.e}</div>`;
            var btn2 = `<div class="quiz-btn" onclick="quizAns('WRONG', '${correct.e}')">${wrong.e}</div>`;
            d.innerHTML = Math.random() > 0.5 ? btn1 + btn2 : btn2 + btn1;
            document.getElementById('quiz-overlay').style.display = 'flex';
            speak(T.speak_prefix + " " + correct[langKey] + "?");
        }

        window.quizAns = function (val, correct) {
            document.getElementById('quiz-overlay').style.display = 'none'; window.speechSynthesis.cancel();
            if (val === correct) { state = 'playing'; activePowerups.shield = 200; reviveUsed = true; obs = []; playSound('powerup'); } else { die(); }
        };
        function die() { state = 'gameover'; if (score > saved.high) saved.high = Math.floor(score); saved.coins += Math.floor(score / 10); save(); }
        function loop() { update(); draw(); requestAnimationFrame(loop); }

        function update() {
            buildings.forEach(function (b) { b.y += speed / 5; if (b.y > h) { b.y = -200; b.x = Math.random() * w; b.h = 50 + Math.random() * 150; } });
            for (var i = particles.length - 1; i >= 0; i--) { var p = particles[i]; p.x += p.vx; p.y += p.vy; p.life--; if (p.life <= 0) particles.splice(i, 1); }

            if (state !== 'playing') return; // STOP UPDATES IF PAUSED

            if (activePowerups.shield > 0) activePowerups.shield--;
            if (activePowerups.x2 > 0) activePowerups.x2--;
            if (activePowerups.mag > 0) activePowerups.mag--;

            if (saved.diff !== 0) {
                baseSpeed = Math.min(30, baseSpeed + 0.005);
            } else {
                var targetSpeed = 2 + (saved.kSpeed * 0.5);
                baseSpeed = targetSpeed;
            }

            if (activePowerups.slow > 0) { activePowerups.slow--; speed = baseSpeed * 0.5; } else { speed = baseSpeed; }

            var scoreAdd = speed / 10; if (activePowerups.x2 > 0) scoreAdd *= 2; score += scoreAdd;
            roadOffset = (roadOffset + speed) % 40;

            if (player.m) { player.p += 15; var s = getX(player.lane), e = getX(player.tLane); player.x = s + (e - s) * Math.min(player.p / 100, 1); if (player.p >= 100) { player.lane = player.tLane; player.m = false; } }

            for (var i = bullets.length - 1; i >= 0; i--) {
                bullets[i].y -= 25;
                for (var j = obs.length - 1; j >= 0; j--) {
                    if (Math.abs(bullets[i].x - obs[j].x) < 40 && Math.abs(bullets[i].y - obs[j].y) < 40) {
                        addExplosion(obs[j].x, obs[j].y, C.RED); obs.splice(j, 1); bullets.splice(i, 1); playSound('crash'); break;
                    }
                }
                if (i < bullets.length && bullets[i].y < -50) bullets.splice(i, 1);
            }

            // SPAWN
            var spawnRate = Math.max(15, 50 - (speed * 1.5));
            if (saved.diff === 0) spawnRate = 80;

            timers.o++;
            if (timers.o > spawnRate) {
                timers.o = 0;
                var lanes = [0, 1, 2];
                var l1 = lanes[Math.floor(Math.random() * lanes.length)];
                obs.push({ x: getX(l1), y: -50, c: OBSTACLE_COLORS[Math.floor(Math.random() * OBSTACLE_COLORS.length)] });

                var doubleChance = (saved.diff === 0) ? 0.0 : 0.4;

                if (Math.random() < doubleChance && speed > 8) {
                    lanes.splice(lanes.indexOf(l1), 1);
                    var l2 = lanes[Math.floor(Math.random() * lanes.length)];
                    obs.push({ x: getX(l2), y: -50, c: OBSTACLE_COLORS[Math.floor(Math.random() * OBSTACLE_COLORS.length)] });
                }
            }

            timers.g++; if (timers.g > 60) { timers.g = 0; if (Math.random() < 0.4) gold.push({ x: getX(Math.floor(Math.random() * 3)), y: -40 }); }
            for (var i = gold.length - 1; i >= 0; i--) {
                var g = gold[i];
                if (activePowerups.mag > 0) {
                    var dx = player.x - g.x, dy = player.y - g.y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 300) { g.x += dx * 0.1; g.y += dy * 0.1; }
                }
            }

            timers.p++; if (timers.p > 250) {
                timers.p = 0;
                var types = ['shield', 'slow', 'x2', 'ammo', 'mag'];
                pow.push({ x: getX(Math.floor(Math.random() * 3)), y: -40, t: types[Math.floor(Math.random() * types.length)] });
            }

            check(obs, 40, function (o, i) {
                if (activePowerups.shield > 0) { activePowerups.shield = 0; playSound('powerup'); addExplosion(o.x, o.y, C.GREEN); return true; }
                playSound('crash');
                if (!reviveUsed) startQuiz(); else die();
                return false;
            });
            check(gold, 50, function (g, i) { playSound('coin'); saved.coins++; score += 50; return true; });
            check(pow, 50, function (p, i) {
                playSound('powerup');
                if (p.t === 'shield') activePowerups.shield = 400;
                if (p.t === 'slow') { activePowerups.slow = 300; playSound('slow'); }
                if (p.t === 'x2') activePowerups.x2 = 300;
                if (p.t === 'ammo') ammo += 5;
                if (p.t === 'mag') activePowerups.mag = 500;
                return true;
            });
        }

        function check(arr, d, cb) { for (var i = arr.length - 1; i >= 0; i--) { arr[i].y += speed; if (Math.abs(arr[i].x - player.x) < d && Math.abs(arr[i].y - player.y) < d) { if (cb(arr[i], i)) arr.splice(i, 1); } else if (arr[i].y > h + 50) arr.splice(i, 1); } }
        function addExplosion(x, y, c) { if (saved.lowQ) return; for (var i = 0; i < 20; i++) particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15, life: 40, c: c }); }
        function save() { storage.set('neonDataV20', JSON.stringify(saved)); }
        function glow(b, c) { if (saved.lowQ) { ctx.shadowBlur = 0; return; } ctx.shadowBlur = b; ctx.shadowColor = c || C.CYAN; }

        // --- DRAWING ---
        function drawPlayer(x, y, t, s, colOverride) {
            if (!s) s = 1; ctx.save(); ctx.translate(x, y); ctx.scale(s, s);
            var col = colOverride || C[saved.selColor[t] || VEHICLES[t].defCol];
            glow(30, col); ctx.lineWidth = 2; ctx.strokeStyle = col; ctx.fillStyle = "#000";

            if (t === 'sport') { ctx.beginPath(); ctx.moveTo(0, -45); ctx.lineTo(15, -35); ctx.lineTo(18, -15); ctx.lineTo(22, 20); ctx.lineTo(25, 25); ctx.lineTo(20, 42); ctx.lineTo(0, 38); ctx.lineTo(-20, 42); ctx.lineTo(-25, 25); ctx.lineTo(-22, 20); ctx.lineTo(-18, -15); ctx.lineTo(-15, -35); ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-22, 35); ctx.lineTo(22, 35); ctx.lineWidth = 3; ctx.stroke(); ctx.lineWidth = 2; glow(10, C.WHITE); ctx.fillStyle = C.WHITE; ctx.fillRect(-15, -32, 8, 4); ctx.fillRect(7, -32, 8, 4); }
            else if (t === 'suv') { ctx.lineWidth = 3; ctx.beginPath(); ctx.rect(-25, -40, 50, 80); ctx.fill(); ctx.stroke(); ctx.fillStyle = col; ctx.globalAlpha = 0.3; ctx.fillRect(-15, -20, 30, 40); ctx.globalAlpha = 1; ctx.fillStyle = col; ctx.fillRect(-30, -35, 6, 20); ctx.fillRect(24, -35, 6, 20); ctx.fillRect(-30, 15, 6, 20); ctx.fillRect(24, 15, 6, 20); ctx.fillStyle = C.YELLOW; ctx.fillRect(-10, -35, 20, 5); }
            else if (t === 'moto') { ctx.shadowColor = col; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(0, -40); ctx.lineTo(0, 40); ctx.stroke(); ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); ctx.fillStyle = col; ctx.beginPath(); ctx.arc(0, 0, 5, 0, Math.PI * 2); ctx.fill(); if (!colOverride) { glow(20, col); ctx.globalAlpha = 0.5; ctx.beginPath(); ctx.moveTo(0, 40); ctx.lineTo(0, 60); ctx.stroke(); ctx.globalAlpha = 1; } }
            else if (t === 'future') { ctx.strokeStyle = col; ctx.fillStyle = '#1a0b2e'; ctx.beginPath(); ctx.ellipse(0, 0, 30, 30, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0, -35); ctx.lineTo(0, 35); ctx.moveTo(-35, 0); ctx.lineTo(35, 0); ctx.stroke(); var r = (Date.now() / 500) % (Math.PI * 2); ctx.fillStyle = col; ctx.beginPath(); ctx.arc(Math.cos(r) * 20, Math.sin(r) * 20, 5, 0, Math.PI * 2); ctx.fill(); }
            else { ctx.fillStyle = '#222'; ctx.fillRect(-22, -40, 44, 80); ctx.strokeRect(-22, -40, 44, 80); ctx.beginPath(); ctx.moveTo(-22, -10); ctx.lineTo(-10, -20); ctx.lineTo(-10, 20); ctx.lineTo(-22, 10); ctx.stroke(); ctx.beginPath(); ctx.moveTo(22, -10); ctx.lineTo(10, -20); ctx.lineTo(10, 20); ctx.lineTo(22, 10); ctx.stroke(); ctx.fillStyle = col; for (var i = 0; i < 4; i++) ctx.fillRect(-15, 25 + i * 4, 30, 2); }

            if (!colOverride) { glow(20, C.CYAN); ctx.fillStyle = C.CYAN; ctx.beginPath(); ctx.arc(0, 0, 3, 0, Math.PI * 2); ctx.fill(); }
            if (activePowerups.shield > 0 || player.shield > 0) { glow(30, C.BLUE); ctx.strokeStyle = C.BLUE; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(0, 0, 60, 0, Math.PI * 2); ctx.stroke(); }
            if (activePowerups.mag > 0) { glow(20, C.PURPLE); ctx.strokeStyle = C.PURPLE; ctx.lineWidth = 1; ctx.beginPath(); ctx.arc(0, 0, 80 + (Date.now() % 20), 0, Math.PI * 2); ctx.stroke(); }

            ctx.restore(); glow(0);
        }

        function draw() {
            // Basic Draw
            ctx.fillStyle = "#050510"; ctx.fillRect(0, 0, w, h);
            if (!saved.lowQ) { buildings.forEach(function (b) { ctx.fillStyle = `rgba(20, 20, 40, 0.8)`; ctx.fillRect(b.x, b.y, b.w, b.h); b.wins.forEach(function (win) { if (win.on) { var wc = ['#ff00ff', '#00ffff', '#ffff00'][Math.floor(b.x) % 3]; ctx.fillStyle = wc; ctx.globalAlpha = 0.5; ctx.fillRect(b.x + win.x, b.y + win.y, 10, 15); ctx.globalAlpha = 1; } }); }); }

            var rw = Math.min(w, 600) * 0.8, rl = (w - rw) / 2;
            glow(15, C.PINK); ctx.strokeStyle = C.PINK; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(rl, 0); ctx.lineTo(rl, h); ctx.stroke(); ctx.beginPath(); ctx.moveTo(rl + rw, 0); ctx.lineTo(rl + rw, h); ctx.stroke();
            var dy = roadOffset * 5; ctx.fillStyle = C.PINK; for (var i = -50; i < h; i += 80) { var y = i + dy; if (y > h) y -= h + 50; ctx.beginPath(); ctx.arc(rl, y, 6, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(rl + rw, y, 6, 0, Math.PI * 2); ctx.fill(); }
            glow(10, C.CYAN); ctx.strokeStyle = C.CYAN; ctx.lineWidth = 4; ctx.setLineDash([40, 40]); ctx.lineDashOffset = -dy; var lw = rw / 3; for (var i = 1; i < 3; i++) { ctx.beginPath(); ctx.moveTo(rl + lw * i, 0); ctx.lineTo(rl + lw * i, h); ctx.stroke(); } ctx.setLineDash([]); glow(0);

            bullets.forEach(function (b) { glow(15, C.YELLOW); ctx.strokeStyle = C.YELLOW; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(b.x, b.y + 15); ctx.stroke(); });

            if (state === 'menu') drawMenu();
            else if (state === 'settings') drawSettings();
            else if (state === 'garage') drawGarage();
            else if (state === 'playing' || state === 'paused' || state === 'quiz') drawGame();
            else if (state === 'gameover') drawGameOver();
        }

        function drawGame() {
            if (!saved.lowQ) particles.forEach(function (p) { ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.life / 10 + 1, 0, 7); ctx.fill(); });

            obs.forEach(function (o) {
                var col = o.c || C.RED; glow(20, col); ctx.fillStyle = "rgba(0,0,0,0.8)"; var ox = o.x - 25, oy = o.y - 20, ow = 50, oh = 40; ctx.fillRect(ox, oy, ow, oh); ctx.strokeStyle = col; ctx.lineWidth = 3; ctx.strokeRect(ox, oy, ow, oh); ctx.beginPath(); ctx.lineWidth = 2; ctx.strokeStyle = col; for (var i = 10; i < ow; i += 10) { ctx.moveTo(ox + i, oy); ctx.lineTo(ox + i - 10, oy + oh); } ctx.stroke(); glow(10, col); ctx.strokeRect(ox + 10, oy + 10, ow - 20, oh - 20);
            });
            gold.forEach(function (g) { glow(15, C.YELLOW); ctx.fillStyle = C.YELLOW; ctx.beginPath(); ctx.arc(g.x, g.y, 10, 0, 7); ctx.fill(); ctx.fillText("$", g.x - 3, g.y + 3); });
            pow.forEach(function (p) { var col = C.GREEN; var txt = "S"; if (p.t === 'shield') { col = C.BLUE; txt = "üõ°Ô∏è"; } if (p.t === 'slow') { col = C.GREEN; txt = "‚è±Ô∏è"; } if (p.t === 'x2') { col = C.YELLOW; txt = "2X"; } if (p.t === 'ammo') { col = C.RED; txt = "üî´"; } if (p.t === 'mag') { col = C.PURPLE; txt = "üß≤"; } glow(20, col); ctx.fillStyle = col; ctx.beginPath(); ctx.arc(p.x, p.y, 15, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = "#fff"; ctx.font = "20px Arial"; ctx.textAlign = "center"; ctx.fillText(txt, p.x, p.y + 7); });

            glow(0); drawPlayer(player.x, player.y, saved.cur);

            // HUD
            ctx.textAlign = "left"; glow(20, C.CYAN); ctx.fillStyle = C.CYAN; ctx.font = "bold 40px Verdana"; ctx.fillText(T.score + ": " + Math.floor(score), 20, 60);
            ctx.fillStyle = "#333"; ctx.fillRect(20, 80, 200, 15); glow(10, C.PINK); ctx.fillStyle = C.PINK; ctx.fillRect(20, 80, 200 * (speed / 30), 15); ctx.font = "12px Verdana"; ctx.fillStyle = "#fff"; ctx.fillText(T.speed + ": " + Math.floor((speed / 30) * 100) + "%", 230, 92);

            // PAUSE BUTTON (Right Top)
            glow(15, C.RED); ctx.fillStyle = "rgba(255,0,0,0.2)"; ctx.strokeStyle = C.RED; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(w - 30, 30, 20, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
            // Pause Icon
            ctx.fillStyle = C.WHITE; ctx.fillRect(w - 35, 20, 4, 20); ctx.fillRect(w - 29, 20, 4, 20);

            // Gold & Ammo moved down
            ctx.textAlign = "right"; glow(20, C.YELLOW); ctx.fillStyle = C.YELLOW; ctx.font = "bold 30px Verdana"; ctx.fillText(T.coin + ": " + saved.coins, w - 20, 80);
            ctx.fillStyle = C.RED; ctx.font = "24px Verdana"; ctx.fillText(T.ammo + ": " + ammo, w - 20, h - 40);

            // Powerups
            ctx.textAlign = "left"; var py = 150;
            if (activePowerups.shield > 0) { ctx.fillStyle = C.BLUE; ctx.fillText("üõ°Ô∏è SHIELD", 20, py); py += 40; }
            if (activePowerups.x2 > 0) { ctx.fillStyle = C.YELLOW; ctx.fillText("2X SCORE", 20, py); py += 40; }
            if (activePowerups.slow > 0) { ctx.fillStyle = C.GREEN; ctx.fillText("‚è±Ô∏è SLOW", 20, py); py += 40; }
            if (activePowerups.mag > 0) { ctx.fillStyle = C.PURPLE; ctx.fillText("üß≤ MAGNET", 20, py); py += 40; }

            // PAUSED OVERLAY
            if (state === 'paused') {
                ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.fillRect(0, 0, w, h);
                var cx = w / 2;
                glow(30, C.CYAN); ctx.textAlign = "center"; ctx.fillStyle = C.CYAN; ctx.font = "bold 50px Verdana"; ctx.fillText(T.paused, cx, h / 2 - 100); glow(0);

                // RESUME BTN
                ctx.fillStyle = C.GREEN; ctx.fillRect(cx - 100, h / 2 - 60, 200, 50);
                ctx.fillStyle = "#fff"; ctx.font = "24px Verdana"; ctx.fillText(T.resume, cx, h / 2 - 28);

                // MENU BTN
                ctx.fillStyle = C.RED; ctx.fillRect(cx - 100, h / 2 + 10, 200, 50);
                ctx.fillStyle = "#fff"; ctx.fillText(T.menu, cx, h / 2 + 42);
            }
        }

        function drawMenu() {
            var cx = w / 2, cy = h / 2; glow(20, C.PINK); ctx.textAlign = "center"; ctx.fillStyle = C.PINK; ctx.font = "bold 80px Verdana"; ctx.fillText("NEON", cx, cy - 60);
            glow(20, C.CYAN); ctx.fillStyle = C.CYAN; ctx.fillText("DRIFT", cx, cy + 40); glow(0);
            ctx.fillStyle = "#fff"; ctx.font = "24px Verdana"; if (parseInt(Date.now() / 500) % 2) ctx.fillText(T.tap, cx, cy + 140);
            ctx.textAlign = "right"; ctx.fillText(T.garage + " üöó", w - 30, 60); ctx.textAlign = "left"; ctx.fillText("‚öôÔ∏è " + T.settings, 30, 60);
            if (saved.diff === 0) { ctx.textAlign = "center"; ctx.fillStyle = C.GREEN; ctx.font = "bold 20px Verdana"; ctx.fillText("üë∂ KIDS MODE ACTIVE", cx, h - 20); }
        }

        function drawSettings() {
            var cx = w / 2; ctx.fillStyle = "rgba(0,0,0,0.95)"; ctx.fillRect(0, 0, w, h);
            glow(20, C.CYAN); ctx.textAlign = "center"; ctx.fillStyle = C.CYAN; ctx.font = "bold 40px Verdana"; ctx.fillText(T.settings, cx, 80); glow(0);
            ctx.font = "24px Verdana"; ctx.fillStyle = C.WHITE; ctx.fillText(T.vol + ": " + saved.vol * 10 + "%", cx, 200);
            ctx.fillStyle = "#333"; ctx.fillRect(50, 220, w - 100, 20); ctx.fillStyle = C.GREEN; ctx.fillRect(50, 220, (w - 100) * (saved.vol / 10), 20);
            var diffT = ["EASY (KIDS)", "NORMAL", "HARD"];
            ctx.fillStyle = C.WHITE; ctx.fillText(T.diff + ": " + diffT[saved.diff], cx, 300);
            ctx.fillStyle = C.BLUE; ctx.fillRect(cx - 100, 320, 200, 40); ctx.fillStyle = "#fff"; ctx.fillText(diffT[saved.diff], cx, 347);
            if (saved.diff === 0) {
                ctx.fillStyle = C.WHITE; ctx.fillText(T.kspeed + ": " + (saved.kSpeed * 10) + "%", cx, 600);
                ctx.fillStyle = "#333"; ctx.fillRect(50, 620, w - 100, 20); ctx.fillStyle = C.YELLOW; ctx.fillRect(50, 620, (w - 100) * (saved.kSpeed / 10), 20);
            }
            ctx.fillStyle = C.WHITE; ctx.fillText("LANGUAGE: " + saved.lang, cx, 400);
            ctx.fillStyle = C.PURPLE; ctx.fillRect(cx - 100, 420, 200, 40); ctx.fillStyle = "#fff"; ctx.fillText(saved.lang, cx, 447);
            ctx.fillStyle = C.WHITE; ctx.fillText(T.graph + ": " + (saved.lowQ ? "LOW" : "ULTRA"), cx, 500);
            ctx.fillStyle = saved.lowQ ? C.RED : C.CYAN; ctx.fillRect(cx - 100, 520, 200, 40); ctx.fillStyle = "#fff"; ctx.fillText(saved.lowQ ? "LOW" : "ULTRA", cx, 547);
            ctx.textAlign = "left"; ctx.fillStyle = C.WHITE; ctx.fillText("üîô " + T.back, 30, 60);
        }

        function drawGameOver() {
            ctx.fillStyle = "rgba(0,0,0,0.9)"; ctx.fillRect(0, 0, w, h); var cx = w / 2, cy = h / 2;
            glow(30, C.RED); ctx.textAlign = "center"; ctx.fillStyle = C.RED; ctx.font = "bold 60px Verdana"; ctx.fillText(T.gameover, cx, cy - 40); glow(0);
            ctx.fillStyle = C.CYAN; ctx.font = "40px Verdana"; ctx.fillText(T.score + ": " + Math.floor(score), cx, cy + 40);
            ctx.fillStyle = C.YELLOW; ctx.font = "30px Verdana"; ctx.fillText(T.coin + ": " + saved.coins, cx, cy + 100);
            if (parseInt(Date.now() / 500) % 2) ctx.fillText(T.restart, cx, cy + 200);
        }

        var gIdx = 0; function garageNav(d) { var k = Object.keys(VEHICLES); gIdx += d; if (gIdx < 0) gIdx = k.length - 1; if (gIdx >= k.length) gIdx = 0; }
        function buy() { var k = Object.keys(VEHICLES), id = k[gIdx]; if (saved.cars.includes(id)) { playSound('select'); saved.cur = id; save(); } else if (saved.coins >= VEHICLES[id].price) { playSound('coin'); saved.coins -= VEHICLES[id].price; saved.cars.push(id); saved.cur = id; save(); } }
        function buyColor(key) {
            if (!saved.cars.includes(Object.keys(VEHICLES)[gIdx])) return;
            var car = Object.keys(VEHICLES)[gIdx];
            if (saved.ownColors[car].includes(key)) { saved.selColor[car] = key; playSound('select'); save(); }
            else { var price = COLOR_PRICES[key]; if (saved.coins >= price) { saved.coins -= price; saved.ownColors[car].push(key); saved.selColor[car] = key; playSound('coin'); save(); } else { playSound('error'); } }
        }

        function drawGarage() {
            ctx.fillStyle = "#000"; ctx.fillRect(0, 0, w, h); var cx = w / 2, k = Object.keys(VEHICLES), id = k[gIdx], v = VEHICLES[id], own = saved.cars.includes(id), sel = saved.cur === id;
            ctx.textAlign = "center"; ctx.fillStyle = C.YELLOW; ctx.font = "40px Verdana"; ctx.fillText(T.garage, cx, 60); ctx.fillText("$ " + saved.coins, cx, 100);
            drawPlayer(cx, h / 2 - 60, id, 2.5);
            glow(10, C.WHITE); ctx.fillStyle = "#fff"; ctx.font = "40px Verdana"; ctx.fillText(v.name, cx, h / 2 - 160); glow(0);
            ctx.fillStyle = C.CYAN; ctx.font = "20px Verdana"; ctx.fillText(T.speed + ": " + (v.speed * 10) + "/15", cx, h / 2 + 40);
            ctx.fillStyle = "#fff"; ctx.font = "50px Verdana"; ctx.fillText("<", 40, h / 2); ctx.fillText(">", w - 40, h / 2);
            var col = C.RED, txt = T.buy + " (" + v.price + ")"; if (own) { col = sel ? C.GREEN : C.BLUE; txt = sel ? T.equipped : T.equip; } else if (saved.coins >= v.price) col = C.YELLOW;
            glow(15, col); ctx.fillStyle = col; ctx.fillRect(cx - 100, h - 80, 200, 60); ctx.fillStyle = "#000"; ctx.font = "bold 24px Verdana"; ctx.fillText(txt, cx, h - 40); glow(0);
            if (own) {
                var startX = cx - (COLOR_KEYS.length * 35) / 2; var yPos = h / 2 + 100;
                ctx.textAlign = "center"; ctx.font = "14px Verdana"; ctx.fillStyle = "#fff"; ctx.fillText(T.color, cx, yPos - 15);
                for (var i = 0; i < COLOR_KEYS.length; i++) {
                    var k = COLOR_KEYS[i]; var c = C[k]; var isOwned = saved.ownColors[id].includes(k); var isSel = saved.selColor[id] === k;
                    ctx.fillStyle = c; ctx.fillRect(startX + i * 35, yPos, 30, 30);
                    if (isSel) { ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.strokeRect(startX + i * 35, yPos, 30, 30); }
                    if (!isOwned) { ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(startX + i * 35, yPos, 30, 30); ctx.fillStyle = "#fff"; ctx.font = "10px Verdana"; ctx.fillText(COLOR_PRICES[k], startX + i * 35 + 15, yPos + 18); }
                }
            } else { ctx.fillStyle = "#555"; ctx.font = "14px Verdana"; ctx.fillText("SATIN ALARAK RENK DEƒûƒ∞≈ûTƒ∞R", cx, h / 2 + 110); }
            ctx.textAlign = "left"; ctx.fillStyle = "#fff"; ctx.font = "30px Verdana"; ctx.fillText("üîô", 30, 50);
        }
    </script>
</body>

</html>