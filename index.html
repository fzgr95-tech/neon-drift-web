<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>NEON DRIFT v3.0</title>
    <style>
        body {
            background-color: #0a0a0f;
            margin: 0;
            overflow: hidden;
            color: white;
            font-family: sans-serif;
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: #111;
        }

        #debug {
            position: fixed;
            top: 0;
            left: 0;
            color: red;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            font-size: 12px;
            pointer-events: none;
        }

        #loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #00ffff;
        }
    </style>
</head>

<body>

    <div id="debug"></div>
    <div id="loader">YÃœKLENÄ°YOR...</div>
    <canvas id="gameCanvas"></canvas>

    <script>
        // 1. HATA YAKALAYICI (En baÅŸa)
        window.onerror = function (msg, url, line) {
            document.getElementById('debug').innerHTML += "HATA: " + msg + " (SatÄ±r: " + line + ")<br>";
            return false;
        };

        // 2. GÃœVENLÄ° STORAGE
        var storage = {
            get: function (key) {
                try { return localStorage.getItem(key); } catch (e) { return null; }
            },
            set: function (key, val) {
                try { localStorage.setItem(key, val); } catch (e) { }
            }
        };

        // AYARLAR
        var COLORS = {
            CYAN: '#00ffff', PINK: '#ff00ff', YELLOW: '#ffff00', RED: '#ff3366',
            GREEN: '#00ff64', BLUE: '#0096ff', DARK: '#1e1e28'
        };

        var VEHICLES = {
            sport: { price: 0, name: "Spor" },
            suv: { price: 300, name: "SUV" },
            moto: { price: 400, name: "Motor" },
            future: { price: 600, name: "Gelecek" },
            retro: { price: 500, name: "Retro" }
        };

        // DEÄžÄ°ÅžKENLER
        var canvas, ctx;
        var width, height;
        var state = 'menu'; // menu, garage, playing, gameover
        var score = 0;
        var coins = 0;
        var highScore = 0;
        var speed = 5;

        // OYUNCU
        var player = { lane: 1, x: 0, y: 0, targetLane: 1, moving: false, progress: 0, shield: 0 };
        var road = { width: 0, left: 0, laneWidth: 0, offset: 0 };

        // OBJELER
        var obstacles = [];
        var coinItems = [];
        var powerups = [];
        var timers = { obs: 0, coin: 0, pow: 0 };

        // VERÄ° YÃœKLEME
        var savedData = { coins: 0, cars: ['sport'], colors: ['default'], curCar: 'sport', curCol: 'default', high: 0 };
        try {
            var raw = storage.get('neonDriftV3');
            if (raw) savedData = JSON.parse(raw);
        } catch (e) { }
        coins = savedData.coins;
        highScore = savedData.high;

        // BAÅžLATMA
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');

            window.addEventListener('resize', resize);
            resize();

            // Dokunmatik
            var ts = 0;
            canvas.addEventListener('touchstart', function (e) {
                e.preventDefault();
                ts = e.touches[0].clientX;
                handleInput(e.touches[0].clientX, e.touches[0].clientY, 'tap');
            }, { passive: false });

            canvas.addEventListener('touchend', function (e) {
                e.preventDefault();
                var te = e.changedTouches[0].clientX;
                if (Math.abs(te - ts) > 30) {
                    handleInput(0, 0, te < ts ? 'left' : 'right');
                }
            }, { passive: false });

            // Mouse/Klavye
            canvas.addEventListener('mousedown', function (e) {
                var r = canvas.getBoundingClientRect();
                handleInput(e.clientX - r.left, e.clientY - r.top, 'tap');
            });

            document.addEventListener('keydown', function (e) {
                if (e.key === 'ArrowLeft') handleInput(0, 0, 'left');
                if (e.key === 'ArrowRight') handleInput(0, 0, 'right');
                if (e.key === 'Enter') handleInput(0, 0, 'tap');
            });

            // YÃ¼kleme ekranÄ±nÄ± kaldÄ±r
            document.getElementById('loader').style.display = 'none';

            loop();
        }

        function resize() {
            var w = window.innerWidth;
            var h = window.innerHeight;
            canvas.width = w > 500 ? 500 : w;
            canvas.height = h;

            road.width = canvas.width * 0.85;
            road.left = (canvas.width - road.width) / 2;
            road.laneWidth = road.width / 3;

            player.y = canvas.height - 120;
            player.x = getLaneX(player.lane);
        }

        function getLaneX(lane) {
            return road.left + road.laneWidth * lane + road.laneWidth / 2;
        }

        function saveData() {
            savedData.coins = coins;
            savedData.high = highScore;
            storage.set('neonDriftV3', JSON.stringify(savedData));
        }

        // GÄ°RDÄ° Ä°ÅžLEME
        var garageTab = 0; // 0:cars
        var garageIdx = 0;

        function handleInput(x, y, type) {
            if (state === 'menu') {
                if (type === 'tap') {
                    if (y < 100 && x > canvas.width - 80) state = 'garage';
                    else startGame();
                }
            } else if (state === 'playing') {
                if (type === 'left') movePlayer(-1);
                if (type === 'right') movePlayer(1);
            } else if (state === 'gameover') {
                if (type === 'tap') state = 'menu';
            } else if (state === 'garage') {
                if (type === 'tap') {
                    if (y < 80 && x < 80) state = 'menu'; // Back
                    else if (y > canvas.height - 100) buyCar(); // Buy
                    else if (x < 100) changeCar(-1); // Prev
                    else if (x > canvas.width - 100) changeCar(1); // Next
                } else if (type === 'left') changeCar(-1);
                else if (type === 'right') changeCar(1);
            }
        }

        function movePlayer(dir) {
            if (player.moving) return;
            var next = player.lane + dir;
            if (next >= 0 && next <= 2) {
                player.targetLane = next;
                player.moving = true;
                player.progress = 0;
            }
        }

        function changeCar(dir) {
            var keys = Object.keys(VEHICLES);
            garageIdx += dir;
            if (garageIdx < 0) garageIdx = keys.length - 1;
            if (garageIdx >= keys.length) garageIdx = 0;
        }

        function buyCar() {
            var keys = Object.keys(VEHICLES);
            var id = keys[garageIdx];
            var car = VEHICLES[id];

            if (savedData.cars.includes(id)) {
                savedData.curCar = id;
                saveData();
            } else if (coins >= car.price) {
                coins -= car.price;
                savedData.cars.push(id);
                savedData.curCar = id;
                saveData();
            }
        }

        function startGame() {
            state = 'playing';
            score = 0;
            speed = 6;
            obstacles = [];
            coinItems = [];
            powerups = [];
            player.lane = 1;
            player.targetLane = 1;
            player.x = getLaneX(1);
            player.moving = false;
            player.shield = 0;
        }

        // OYUN DÃ–NGÃœSÃœ
        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            if (state !== 'playing') return;

            speed += 0.005;
            if (speed > 20) speed = 20;

            score += speed / 10;
            road.offset = (road.offset + speed) % 40;

            // Oyuncu Hareket
            if (player.moving) {
                player.progress += 15;
                var sx = getLaneX(player.lane);
                var ex = getLaneX(player.targetLane);
                player.x = sx + (ex - sx) * (player.progress / 100);

                if (player.progress >= 100) {
                    player.lane = player.targetLane;
                    player.moving = false;
                }
            }

            if (player.shield > 0) player.shield--;

            // Obje OluÅŸturma
            timers.obs++;
            if (timers.obs > 100 - speed * 2) {
                timers.obs = 0;
                obstacles.push({ x: getLaneX(Math.floor(Math.random() * 3)), y: -50 });
            }

            timers.coin++;
            if (timers.coin > 60) {
                timers.coin = 0;
                if (Math.random() < 0.3) coinItems.push({ x: getLaneX(Math.floor(Math.random() * 3)), y: -30 });
            }

            timers.pow++;
            if (timers.pow > 600) {
                timers.pow = 0;
                powerups.push({
                    x: getLaneX(Math.floor(Math.random() * 3)),
                    y: -30,
                    type: Math.random() < 0.5 ? 'shield' : 'slow'
                });
            }

            // Ã‡arpÄ±ÅŸma ve Temizlik
            updateObjects(obstacles, 30, function (o, i) {
                if (player.shield > 0) {
                    player.shield = 0;
                    return true; // remove obstacle
                }
                die();
                return false;
            });

            updateObjects(coinItems, 40, function (c, i) {
                coins++;
                score += 50;
                return true; // remove
            });

            updateObjects(powerups, 40, function (p, i) {
                if (p.type === 'shield') player.shield = 300;
                else speed = 5;
                return true;
            });
        }

        function updateObjects(list, hitDist, onHit) {
            for (var i = list.length - 1; i >= 0; i--) {
                list[i].y += speed;
                // Hit
                if (Math.abs(list[i].x - player.x) < hitDist && Math.abs(list[i].y - player.y) < hitDist) {
                    if (onHit(list[i], i)) list.splice(i, 1);
                }
                // Remove
                else if (list[i].y > canvas.height + 50) {
                    list.splice(i, 1);
                }
            }
        }

        function die() {
            state = 'gameover';
            if (score > highScore) highScore = Math.floor(score);
            saveData();
        }

        // Ã‡Ä°ZÄ°M
        function draw() {
            // Arka Plan
            ctx.fillStyle = '#0a0a0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Yol
            ctx.fillStyle = '#1e1e28';
            ctx.fillRect(road.left, 0, road.width, canvas.height);

            ctx.strokeStyle = COLORS.PINK;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(road.left, 0); ctx.lineTo(road.left, canvas.height);
            ctx.moveTo(road.left + road.width, 0); ctx.lineTo(road.left + road.width, canvas.height);
            ctx.stroke();

            ctx.strokeStyle = COLORS.CYAN;
            ctx.lineWidth = 2;
            ctx.setLineDash([30, 20]);
            for (var i = 1; i < 3; i++) {
                var x = getLaneX(i) - road.laneWidth / 2;
                ctx.beginPath();
                ctx.moveTo(x, -road.offset);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            ctx.setLineDash([]);

            if (state === 'menu') drawMenu();
            else if (state === 'garage') drawGarage();
            else if (state === 'playing') drawGame();
            else if (state === 'gameover') drawGameOver();
        }

        function drawPlayer(x, y, type) {
            ctx.fillStyle = '#333';
            ctx.strokeStyle = COLORS.CYAN;
            ctx.lineWidth = 3;
            ctx.shadowBlur = 15;
            ctx.shadowColor = COLORS.CYAN;

            ctx.beginPath();
            if (type === 'suv') ctx.rect(x - 20, y - 30, 40, 60);
            else if (type === 'moto') { ctx.moveTo(x, y - 30); ctx.lineTo(x, y + 30); }
            else { ctx.rect(x - 18, y - 30, 36, 60); } // sport

            ctx.fill();
            ctx.stroke();
            ctx.shadowBlur = 0;

            if (player.shield > 0) {
                ctx.strokeStyle = COLORS.GREEN;
                ctx.beginPath();
                ctx.arc(x, y, 40, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        function drawGame() {
            // Objeler
            ctx.fillStyle = COLORS.YELLOW;
            coinItems.forEach(function (c) {
                ctx.beginPath(); ctx.arc(c.x, c.y, 10, 0, Math.PI * 2); ctx.fill();
            });

            obstacles.forEach(function (o) {
                ctx.fillStyle = '#333';
                ctx.strokeStyle = COLORS.RED;
                ctx.lineWidth = 2;
                ctx.fillRect(o.x - 20, o.y - 15, 40, 30);
                ctx.strokeRect(o.x - 20, o.y - 15, 40, 30);
            });

            powerups.forEach(function (p) {
                ctx.fillStyle = p.type === 'shield' ? COLORS.GREEN : COLORS.BLUE;
                ctx.beginPath(); ctx.arc(p.x, p.y, 12, 0, Math.PI * 2); ctx.fill();
            });

            drawPlayer(player.x, player.y, savedData.curCar);

            // HUD
            ctx.fillStyle = COLORS.CYAN;
            ctx.font = "bold 24px Arial";
            ctx.textAlign = "left";
            ctx.fillText(Math.floor(score), 20, 40);

            ctx.textAlign = "right";
            ctx.fillStyle = COLORS.YELLOW;
            ctx.fillText("$ " + coins, canvas.width - 20, 40);
        }

        function drawMenu() {
            ctx.textAlign = "center";
            ctx.fillStyle = COLORS.PINK;
            ctx.font = "bold 40px Arial";
            ctx.fillText("NEON DRIFT", canvas.width / 2, 150);

            ctx.fillStyle = "white";
            ctx.font = "20px Arial";
            ctx.fillText("BaÅŸlamak Ä°Ã§in Dokun", canvas.width / 2, 250);

            ctx.font = "30px Arial";
            ctx.fillText("ðŸš— Garaj", canvas.width - 60, 50);
        }

        function drawGameOver() {
            ctx.fillStyle = "rgba(0,0,0,0.8)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.textAlign = "center";
            ctx.fillStyle = COLORS.RED;
            ctx.font = "bold 40px Arial";
            ctx.fillText("OYUN BÄ°TTÄ°", canvas.width / 2, canvas.height / 2 - 20);

            ctx.fillStyle = COLORS.CYAN;
            ctx.font = "20px Arial";
            ctx.fillText("Skor: " + Math.floor(score), canvas.width / 2, canvas.height / 2 + 30);

            ctx.fillStyle = "white";
            ctx.fillText("Tekrar Oyna", canvas.width / 2, canvas.height / 2 + 80);
        }

        function drawGarage() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.textAlign = "center";
            ctx.fillStyle = COLORS.YELLOW;
            ctx.font = "30px Arial";
            ctx.fillText("GARAJ", canvas.width / 2, 50);

            ctx.font = "20px Arial";
            ctx.fillText("$ " + coins, canvas.width / 2, 80);

            var keys = Object.keys(VEHICLES);
            var id = keys[garageIdx];
            var car = VEHICLES[id];
            var owned = savedData.cars.includes(id);
            var selected = savedData.curCar === id;

            ctx.fillStyle = "white";
            ctx.font = "30px Arial";
            ctx.fillText(car.name, canvas.width / 2, 150);

            // Ã–nizleme
            drawPlayer(canvas.width / 2, 250, id);

            // Buton
            var btnColor = COLORS.RED;
            var btnText = "SATIN AL (" + car.price + ")";

            if (owned) {
                btnColor = selected ? COLORS.GREEN : COLORS.BLUE;
                btnText = selected ? "SEÃ‡Ä°LDÄ°" : "SEÃ‡";
            } else if (coins >= car.price) {
                btnColor = COLORS.YELLOW;
            }

            ctx.fillStyle = btnColor;
            ctx.fillRect(canvas.width / 2 - 80, canvas.height - 120, 160, 50);

            ctx.fillStyle = "black";
            ctx.font = "bold 20px Arial";
            ctx.fillText(btnText, canvas.width / 2, canvas.height - 88);

            // Oklar
            ctx.fillStyle = "white";
            ctx.font = "40px Arial";
            ctx.fillText("<", 40, canvas.height / 2);
            ctx.fillText(">", canvas.width - 40, canvas.height / 2);

            ctx.font = "20px Arial";
            ctx.fillText("GERÄ°", 40, 40);
        }

        window.onload = init;

    </script>
</body>

</html>