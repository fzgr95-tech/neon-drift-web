<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="theme-color" content="#0a0a0f">
    <title>NEON DRIFT ULTIMATE</title>
    <style>
        /* STYLES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0a0a0f;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(180deg, #0a0a0f 0%, #1a0a2e 100%);
            display: flex;
            justify-content: center;
        }

        canvas {
            display: block;
            max-width: 500px;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        /**
         * NEON DRIFT - SINGLE FILE ULTIMATE VERSION
         * v2.0 - Forced Update
         */

        // Service Worker Unregister (Cache temizliƒüi i√ßin)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) { registration.unregister(); }
            });
        }

        // CONSTANTS
        const COLORS = {
            BLACK: '#0a0a0f', NEON_PINK: '#ff00ff', NEON_CYAN: '#00ffff', NEON_BLUE: '#0096ff',
            NEON_PURPLE: '#b400ff', NEON_RED: '#ff3366', NEON_ORANGE: '#ff6400',
            NEON_GREEN: '#00ff64', NEON_YELLOW: '#ffff00', WHITE: '#ffffff', DARK_GRAY: '#1e1e28'
        };

        const VEHICLES = {
            sport: { name: "Spor", price: 0, desc: "Standart Hƒ±z" },
            suv: { name: "SUV", price: 300, desc: "Daha Dayanƒ±klƒ±" },
            moto: { name: "Motor", price: 400, desc: "√áevik" },
            future: { name: "Gelecek", price: 600, desc: "Maksimum Hƒ±z" },
            retro: { name: "Retro", price: 500, desc: "Klasik Stil" }
        };

        const THEMES = {
            default: { name: "Varsayƒ±lan", price: 0, primary: COLORS.NEON_CYAN, secondary: COLORS.NEON_PINK },
            ocean: { name: "Okyanus", price: 100, primary: COLORS.NEON_BLUE, secondary: COLORS.NEON_CYAN },
            emerald: { name: "Z√ºmr√ºt", price: 150, primary: COLORS.NEON_GREEN, secondary: COLORS.NEON_CYAN },
            fire: { name: "Ate≈ü", price: 200, primary: COLORS.NEON_RED, secondary: COLORS.NEON_ORANGE },
            gold: { name: "Altƒ±n", price: 250, primary: COLORS.NEON_YELLOW, secondary: COLORS.NEON_ORANGE },
            rainbow: { name: "G√∂kku≈üaƒüƒ±", price: 500, primary: null, secondary: null }
        };

        const STATES = { MENU: 'menu', GARAGE: 'garage', PLAYING: 'playing', GAMEOVER: 'gameover' };

        // GARAGE MANAGER
        class GarageManager {
            constructor() {
                this.data = JSON.parse(localStorage.getItem('neonDriftDataV2')) || {
                    coins: 0, ownedVehicles: ['sport'], ownedColors: ['default'],
                    currentVehicle: 'sport', currentColor: 'default', highScore: 0
                };
            }
            save() { localStorage.setItem('neonDriftDataV2', JSON.stringify(this.data)); }
            addCoins(n) { this.data.coins += n; this.save(); }
            buyVehicle(id) {
                if (this.data.coins >= VEHICLES[id].price && !this.data.ownedVehicles.includes(id)) {
                    this.data.coins -= VEHICLES[id].price; this.data.ownedVehicles.push(id); this.save(); return true;
                } return false;
            }
            buyColor(id) {
                if (this.data.coins >= THEMES[id].price && !this.data.ownedColors.includes(id)) {
                    this.data.coins -= THEMES[id].price; this.data.ownedColors.push(id); this.save(); return true;
                } return false;
            }
            getColors() {
                if (this.data.currentColor === 'rainbow') {
                    const h = (Date.now() / 20) % 360;
                    return { p: `hsl(${h},100%,50%)`, s: `hsl(${(h + 180) % 360},100%,50%)` };
                }
                const t = THEMES[this.data.currentColor];
                return { p: t.primary, s: t.secondary };
            }
        }

        // GAME ENGINE
        class NeonDrift {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.garage = new GarageManager();
                this.resize();
                window.addEventListener('resize', () => this.resize());

                this.state = STATES.MENU;
                this.score = 0;
                this.speed = 5;
                this.roadOffset = 0;

                // Inputs
                this.setupInputs();

                // Game Objects
                this.player = { lane: 1, targetLane: 1, x: 0, y: 0, moving: false, moveProgress: 0, shield: 0 };
                this.obstacles = []; this.coins = []; this.powerups = [];
                this.timers = { obs: 0, coin: 0, pow: 0 };

                // Garage UI
                this.garageTab = 0; this.garageIndex = 0;

                // Loop
                requestAnimationFrame((t) => this.loop(t));
            }

            resize() {
                const aspect = 9 / 16;
                let w = window.innerWidth, h = window.innerHeight;
                if (w / h > aspect) w = h * aspect;
                this.canvas.width = w; this.canvas.height = h;
                this.roadWidth = w * 0.85;
                this.roadLeft = (w - this.roadWidth) / 2;
                this.laneWidth = this.roadWidth / 3;
                this.player.y = h - 120;
                this.player.x = this.getLaneX(this.player.lane);
            }
            getLaneX(l) { return this.roadLeft + this.laneWidth * l + this.laneWidth / 2; }

            setupInputs() {
                let ts = 0;
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault(); ts = e.touches[0].clientX;
                    this.handleTap(e.touches[0].clientX, e.touches[0].clientY);
                }, { passive: false });

                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const diff = e.changedTouches[0].clientX - ts;
                    if (this.state === STATES.PLAYING && Math.abs(diff) > 30) this.movePlayer(diff > 0 ? 1 : -1);
                }, { passive: false });

                this.canvas.addEventListener('click', (e) => {
                    const r = this.canvas.getBoundingClientRect();
                    this.handleTap(e.clientX - r.left, e.clientY - r.top);
                });

                document.addEventListener('keydown', (e) => {
                    if (this.state === STATES.PLAYING) {
                        if (e.key === 'ArrowLeft') this.movePlayer(-1);
                        if (e.key === 'ArrowRight') this.movePlayer(1);
                    }
                    if (this.state === STATES.MENU && e.key === 'Enter') this.startGame();
                });
            }

            handleTap(x, y) {
                if (this.state === STATES.MENU) {
                    if (y < 100 && x > this.canvas.width - 80) this.state = STATES.GARAGE;
                    else this.startGame();
                } else if (this.state === STATES.GAMEOVER) {
                    this.state = STATES.MENU;
                } else if (this.state === STATES.GARAGE) {
                    if (y < 80 && x < 80) this.state = STATES.MENU;
                    else if (y > 100 && y < 160) { this.garageTab = x < this.canvas.width / 2 ? 0 : 1; this.garageIndex = 0; }
                    else if (y > this.canvas.height / 2 && y < this.canvas.height / 2 + 100) {
                        if (x < 100) this.garageNav(-1); else if (x > this.canvas.width - 100) this.garageNav(1);
                    }
                    else if (y > this.canvas.height - 150) this.garageAction();
                }
            }

            movePlayer(d) {
                const n = this.player.lane + d;
                if (n >= 0 && n <= 2 && !this.player.moving) {
                    this.player.targetLane = n; this.player.moving = true; this.player.moveProgress = 0;
                }
            }

            startGame() {
                this.state = STATES.PLAYING; this.score = 0; this.speed = 6;
                this.player.lane = 1; this.player.targetLane = 1; this.player.x = this.getLaneX(1);
                this.player.moving = false; this.player.shield = 0;
                this.obstacles = []; this.coins = []; this.powerups = [];
            }

            loop() {
                this.update(); this.draw(); requestAnimationFrame(() => this.loop());
            }

            update() {
                if (this.state !== STATES.PLAYING) return;
                this.speed = Math.min(25, this.speed + 0.005);
                this.score += this.speed / 10;
                this.roadOffset = (this.roadOffset + this.speed) % 40;

                // Player Move
                if (this.player.moving) {
                    this.player.moveProgress += 15;
                    const s = this.getLaneX(this.player.lane), e = this.getLaneX(this.player.targetLane);
                    this.player.x = s + (e - s) * Math.min(this.player.moveProgress / 100, 1);
                    if (this.player.moveProgress >= 100) { this.player.lane = this.player.targetLane; this.player.moving = false; }
                }
                if (this.player.shield > 0) this.player.shield--;

                // Spawn
                this.timers.obs++; if (this.timers.obs > 100 - this.speed * 3) {
                    this.obstacles.push({ x: this.getLaneX(Math.floor(Math.random() * 3)), y: -50 }); this.timers.obs = 0;
                }
                this.timers.coin++; if (this.timers.coin > 50) {
                    if (Math.random() < 0.4) this.coins.push({ x: this.getLaneX(Math.floor(Math.random() * 3)), y: -30 }); this.timers.coin = 0;
                }
                this.timers.pow++; if (this.timers.pow > 600) {
                    this.powerups.push({ x: this.getLaneX(Math.floor(Math.random() * 3)), y: -30, type: Math.random() < 0.5 ? 'shield' : 'slow' }); this.timers.pow = 0;
                }

                // Obj Update
                const checkCol = (o, d) => Math.abs(this.player.x - o.x) < d && Math.abs(this.player.y - o.y) < d;

                for (let i = this.obstacles.length - 1; i >= 0; i--) {
                    let o = this.obstacles[i]; o.y += this.speed;
                    if (checkCol(o, 35)) {
                        if (this.player.shield > 0) { this.player.shield = 0; this.obstacles.splice(i, 1); }
                        else {
                            this.state = STATES.GAMEOVER;
                            if (this.score > this.garage.data.highScore) this.garage.data.highScore = Math.floor(this.score);
                            this.garage.addCoins(Math.floor(this.score / 10));
                        }
                    } else if (o.y > this.canvas.height + 50) this.obstacles.splice(i, 1);
                }
                for (let i = this.coins.length - 1; i >= 0; i--) {
                    let c = this.coins[i]; c.y += this.speed;
                    if (checkCol(c, 40)) { this.garage.addCoins(1); this.score += 50; this.coins.splice(i, 1); }
                    else if (c.y > this.canvas.height + 50) this.coins.splice(i, 1);
                }
                for (let i = this.powerups.length - 1; i >= 0; i--) {
                    let p = this.powerups[i]; p.y += this.speed;
                    if (checkCol(p, 40)) {
                        if (p.type === 'shield') this.player.shield = 300; else this.speed = Math.max(5, this.speed - 5);
                        this.powerups.splice(i, 1);
                    } else if (p.y > this.canvas.height + 50) this.powerups.splice(i, 1);
                }
            }

            draw() {
                // BG
                this.ctx.fillStyle = COLORS.BLACK; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Road
                this.ctx.fillStyle = COLORS.DARK_GRAY; this.ctx.fillRect(this.roadLeft, 0, this.roadWidth, this.canvas.height);
                this.ctx.strokeStyle = COLORS.NEON_PINK; this.ctx.lineWidth = 4;
                this.ctx.beginPath(); this.ctx.moveTo(this.roadLeft, 0); this.ctx.lineTo(this.roadLeft, this.canvas.height);
                this.ctx.moveTo(this.roadLeft + this.roadWidth, 0); this.ctx.lineTo(this.roadLeft + this.roadWidth, this.canvas.height); this.ctx.stroke();

                this.ctx.strokeStyle = COLORS.NEON_CYAN; this.ctx.lineWidth = 2; this.ctx.setLineDash([30, 20]);
                for (let i = 1; i < 3; i++) {
                    let x = this.getLaneX(i) - this.laneWidth / 2;
                    this.ctx.beginPath(); this.ctx.moveTo(x, -this.roadOffset); this.ctx.lineTo(x, this.canvas.height); this.ctx.stroke();
                }
                this.ctx.setLineDash([]);

                if (this.state === STATES.MENU) this.drawMenu();
                else if (this.state === STATES.GARAGE) this.drawGarage();
                else if (this.state === STATES.PLAYING) this.drawGame();
                else if (this.state === STATES.GAMEOVER) this.drawGameOver();
            }

            drawMenu() {
                const cx = this.canvas.width / 2, cy = this.canvas.height / 2;
                this.ctx.textAlign = "center";
                this.ctx.font = "bold 50px Arial"; this.ctx.fillStyle = COLORS.NEON_PINK; this.ctx.fillText("NEON", cx, cy - 60);
                this.ctx.fillStyle = COLORS.NEON_CYAN; this.ctx.fillText("DRIFT", cx, cy);
                this.ctx.font = "20px Arial"; this.ctx.fillStyle = COLORS.WHITE; this.ctx.fillText("Ba≈ülamak ƒ∞√ßin Dokun", cx, cy + 80);
                // Garage Btn
                this.ctx.font = "30px Arial"; this.ctx.fillText("üöó", this.canvas.width - 40, 50);
                this.ctx.font = "12px Arial"; this.ctx.fillText("Garaj", this.canvas.width - 40, 70);
            }

            drawGame() {
                // Objs
                this.coins.forEach(c => {
                    this.ctx.fillStyle = COLORS.NEON_YELLOW; this.ctx.beginPath(); this.ctx.arc(c.x, c.y, 12, 0, 7); this.ctx.fill();
                    this.ctx.fillStyle = "#000"; this.ctx.font = "bold 14px Arial"; this.ctx.textAlign = "center"; this.ctx.fillText("$", c.x, c.y + 5);
                });
                this.powerups.forEach(p => {
                    this.ctx.fillStyle = p.type === 'shield' ? COLORS.NEON_GREEN : COLORS.NEON_BLUE;
                    this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 15, 0, 7); this.ctx.fill();
                    this.ctx.fillStyle = "#000"; this.ctx.fillText(p.type === 'shield' ? 'S' : 'T', p.x, p.y + 5);
                });
                this.obstacles.forEach(o => {
                    this.ctx.fillStyle = "#222"; this.ctx.strokeStyle = COLORS.NEON_RED; this.ctx.lineWidth = 3;
                    this.ctx.fillRect(o.x - 25, o.y - 20, 50, 40); this.ctx.strokeRect(o.x - 25, o.y - 20, 50, 40);
                });

                // Player
                const c = this.garage.getColors();
                const t = this.garage.data.currentVehicle;
                const x = this.player.x, y = this.player.y;
                this.ctx.fillStyle = "#222"; this.ctx.strokeStyle = c.p; this.ctx.lineWidth = 3;
                this.ctx.shadowBlur = 15; this.ctx.shadowColor = c.p;

                this.ctx.beginPath();
                if (t === 'suv') this.ctx.rect(x - 22, y - 35, 44, 70);
                else if (t === 'moto') { this.ctx.moveTo(x - 12, y + 30); this.ctx.lineTo(x, y - 35); this.ctx.lineTo(x + 12, y + 30); }
                else if (t === 'future') { this.ctx.moveTo(x - 20, y + 30); this.ctx.lineTo(x, y - 40); this.ctx.lineTo(x + 20, y + 30); }
                else { this.ctx.moveTo(x - 20, y + 30); this.ctx.lineTo(x - 20, y - 10); this.ctx.lineTo(x, y - 35); this.ctx.lineTo(x + 20, y - 10); this.ctx.lineTo(x + 20, y + 30); }
                this.ctx.closePath(); this.ctx.fill(); this.ctx.stroke();

                this.ctx.fillStyle = c.s; this.ctx.shadowBlur = 0;
                this.ctx.beginPath(); this.ctx.arc(x, y, 6, 0, 7); this.ctx.fill();

                if (this.player.shield > 0) {
                    this.ctx.strokeStyle = COLORS.NEON_GREEN; this.ctx.beginPath(); this.ctx.arc(x, y, 50, 0, 7); this.ctx.stroke();
                }

                // HUD
                this.ctx.fillStyle = COLORS.NEON_CYAN; this.ctx.font = "bold 24px Arial"; this.ctx.textAlign = "left"; this.ctx.fillText(Math.floor(this.score), 20, 40);
                this.ctx.textAlign = "right"; this.ctx.fillStyle = COLORS.NEON_YELLOW; this.ctx.fillText(`ü™ô ${this.garage.data.coins}`, this.canvas.width - 20, 40);
            }

            drawGarage() {
                const cx = this.canvas.width / 2;
                this.ctx.fillStyle = "#000"; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.textAlign = "center";

                this.ctx.font = "bold 30px Arial"; this.ctx.fillStyle = COLORS.NEON_YELLOW; this.ctx.fillText("GARAJ", cx, 50);
                this.ctx.font = "20px Arial"; this.ctx.fillText(`ü™ô ${this.garage.data.coins}`, cx, 80);

                // Tabs
                this.ctx.fillStyle = this.garageTab === 0 ? COLORS.NEON_CYAN : "#555"; this.ctx.fillText("ARA√áLAR", cx - 80, 130);
                this.ctx.fillStyle = this.garageTab === 1 ? COLORS.NEON_CYAN : "#555"; this.ctx.fillText("RENKLER", cx + 80, 130);

                const list = this.garageTab === 0 ? Object.keys(VEHICLES) : Object.keys(THEMES);
                const id = list[this.garageIndex];
                const item = this.garageTab === 0 ? VEHICLES[id] : THEMES[id];

                this.ctx.font = "bold 28px Arial"; this.ctx.fillStyle = COLORS.WHITE; this.ctx.fillText(item.name.toUpperCase(), cx, 200);

                // Prev
                if (this.garageTab === 1) {
                    this.ctx.fillStyle = item.primary || `hsl(${(Date.now() / 20) % 360},100%,50%)`;
                    this.ctx.beginPath(); this.ctx.arc(cx, 280, 50, 0, 7); this.ctx.fill();
                } else {
                    this.ctx.fillStyle = "#000"; this.ctx.strokeStyle = COLORS.NEON_CYAN; this.ctx.lineWidth = 3;
                    this.ctx.strokeRect(cx - 25, 250, 50, 60);
                }

                // Buy Button
                const owned = this.garageTab === 0 ? this.garage.data.ownedVehicles.includes(id) : this.garage.data.ownedColors.includes(id);
                const sel = this.garageTab === 0 ? this.garage.data.currentVehicle === id : this.garage.data.currentColor === id;

                let color = COLORS.NEON_RED, txt = `AL (${item.price})`;
                if (owned) { color = sel ? COLORS.NEON_GREEN : COLORS.NEON_BLUE; txt = sel ? "SE√áƒ∞LDƒ∞" : "SE√á"; }
                else if (this.garage.data.coins >= item.price) color = COLORS.NEON_YELLOW;

                this.ctx.fillStyle = color; this.ctx.fillRect(cx - 100, this.canvas.height - 140, 200, 50);
                this.ctx.fillStyle = "#000"; this.ctx.font = "bold 22px Arial"; this.ctx.fillText(txt, cx, this.canvas.height - 108);

                // Nav
                this.ctx.fillStyle = COLORS.WHITE; this.ctx.font = "40px Arial";
                this.ctx.fillText("‚Üê", 40, 300); this.ctx.fillText("‚Üí", this.canvas.width - 40, 300);
                this.ctx.font = "30px Arial"; this.ctx.fillText("üîô", 30, 40);
            }

            drawGameOver() {
                const cx = this.canvas.width / 2, cy = this.canvas.height / 2;
                this.ctx.fillStyle = "rgba(0,0,0,0.9)"; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.textAlign = "center";

                this.ctx.fillStyle = COLORS.NEON_RED; this.ctx.font = "bold 40px Arial"; this.ctx.fillText("OYUN Bƒ∞TTƒ∞", cx, cy - 50);
                this.ctx.fillStyle = COLORS.NEON_CYAN; this.ctx.font = "24px Arial"; this.ctx.fillText(`Skor: ${Math.floor(this.score)}`, cx, cy);
                this.ctx.fillStyle = COLORS.WHITE; this.ctx.font = "20px Arial"; this.ctx.fillText("Tekrar Oyna", cx, cy + 80);
            }

            garageNav(d) {
                const l = this.garageTab === 0 ? Object.keys(VEHICLES) : Object.keys(THEMES);
                let i = this.garageIndex + d; if (i < 0) i = l.length - 1; if (i >= l.length) i = 0;
                this.garageIndex = i;
            }
            garageAction() {
                const l = this.garageTab === 0 ? Object.keys(VEHICLES) : Object.keys(THEMES);
                const id = l[this.garageIndex];
                if (this.garageTab === 0) {
                    if (this.garage.data.ownedVehicles.includes(id)) { this.garage.data.currentVehicle = id; this.garage.save(); }
                    else this.garage.buyVehicle(id);
                } else {
                    if (this.garage.data.ownedColors.includes(id)) { this.garage.data.currentColor = id; this.garage.save(); }
                    else this.garage.buyColor(id);
                }
            }
        }

        // Start
        window.onload = () => new NeonDrift();
    </script>
</body>

</html>